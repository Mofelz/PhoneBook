name: iOS-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: PhoneBookIOS
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Clean and install dependencies
        run: |
          flutter clean
          rm -f pubspec.lock
          flutter pub get

      - name: Install CocoaPods
        run: |
          brew install cocoapods
          pod --version

      - name: Set up Xcode project
        run: |
          cd ios
          sed -i '' 's/platform :ios, .*/platform :ios, "12.0"/' Podfile
          pod deintegrate || true
          pod cache clean --all
          pod install --repo-update

      - name: Build iOS
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -qry9 FlutterIpaExport.ipa Payload

      - name: Create Release & Upload IPA
        run: |
          # Создаем release через GitHub API
          RESPONSE=$(curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d '{
              "tag_name": "v1.0.0",
              "name": "iOS v1.0.0",
              "body": "iOS release build",
              "draft": false,
              "prerelease": false
            }')
          
          # Получаем upload URL из ответа
          UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.upload_url' | sed 's/{?name,label}//')
          
          # Загружаем IPA
          curl -L \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary @build/ios/iphoneos/FlutterIpaExport.ipa \
            "$UPLOAD_URL?name=FlutterIpaExport.ipa"
